<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyper Type</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c4a6e; /* sky-800 */
            /* Updated background gradient colors to match the theme blue */
            background-image: radial-gradient(circle at top right, #38bdf8, transparent), radial-gradient(circle at bottom left, #0284c7, transparent); /* sky-400 and sky-700 */
            background-attachment: fixed;
        }
        .font-logo { font-family: 'Inter', sans-serif; font-weight: 900; text-transform: uppercase; }
        /* Changed from logo-n to logo-h and color changed to blue */
        .logo-h { background-color: #38bdf8; color: white; padding: 0 0.5rem; border-radius: 4px; margin-right: -4px; }
        .car-svg-container { width: 100px; height: 50px; }
        .car { transition: left 0.2s linear; }
        .letter { font-size: 1.5rem; padding: 0.1rem; border-radius: 4px; transition: background-color 0.2s, color 0.2s; }
        .letter.correct { color: #4ade80; }
        .letter.incorrect { color: #f87171; background-color: rgba(248, 113, 113, 0.2); }
        .letter.current { background-color: #60a5fa; color: #1e293b; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { background-color: #60a5fa; } 50% { background-color: #93c5fd; } }
        .view { display: none; }
        .view.active { display: block; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; }
        .card-item { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; justify-content: center; align-items: center; }
        .card-item:hover { transform: scale(1.05); }
        .card-item.selected { transform: scale(1.05); box-shadow: 0 0 15px 5px #38bdf8; background-color: rgba(56, 189, 248, 0.1); }
        .nav-main { background-color: #1e293b; border-bottom: 2px solid #334155; }
        .nav-btn { color: #cbd5e1; font-weight: 700; padding: 1rem 1.5rem; border-bottom: 4px solid transparent; transition: all 0.2s ease-in-out; }
        .nav-btn:hover { color: white; background-color: #334155; }
        .nav-btn.active { color: white; border-bottom-color: #38bdf8; }
        .nav-btn.nav-race.active { color: #38bdf8; } /* Blue color for active Race button */
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background-color: #38bdf8; color: white; }
        .btn-primary:hover { background-color: #0ea5e9; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-disabled { background-color: #475569; color: #94a3b8; cursor: not-allowed; }
        .input { background-color: #334155; border: 1px solid #475569; color: white; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
        .hidden { display: none; }
        .progress-bar { background-color: #334155; border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { background-color: #f59e0b; height: 100%; border-radius: 9999px; transition: width 0.5s; }
        /* Admin badge style */
        .admin-badge {
            background-color: #f59e0b; /* Amber-500 */
            color: #1e293b; /* Slate-800 */
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Race Track specific styles for multiple lanes */
        #race-track {
            height: auto; /* Allow height to adjust based on content */
            min-height: 250px; /* Minimum height to show multiple lanes */
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding-bottom: 1rem; /* Add some padding at the bottom */
        }

        .lane {
            position: relative;
            width: 100%;
            height: 50px; /* Height for each lane */
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2); /* Lane separator */
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .lane:last-child {
            border-bottom: none; /* No border for the last lane */
        }

        .lane .car {
            position: absolute;
            top: 0; /* Align car to the top of its lane */
            transform: translateY(0); /* Remove vertical centering from global .car */
        }

        .lane-label {
            position: absolute;
            left: 5px;
            top: 5px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            z-index: 10;
        }
    </style>
</head>
<body class="text-slate-100">

    <div id="svg-defs" style="width:0; height:0; position:absolute; overflow:hidden;">
      <svg><defs>
        <linearGradient id="grad-fire"><stop offset="0%" stop-color="#f97316"/><stop offset="100%" stop-color="#ef4444"/></linearGradient>
        <linearGradient id="grad-ocean"><stop offset="0%" stop-color="#38bdf8"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient>
        <linearGradient id="grad-forest"><stop offset="0%" stop-color="#84cc16"/><stop offset="100%" stop-color="#22c55e"/></linearGradient>
        <linearGradient id="grad-galaxy"><stop offset="0%" stop-color="#a855f7"/><stop offset="100%" stop-color="#6d28d9"/></linearGradient>
        <!-- New gradients for new cars -->
        <linearGradient id="grad-purple-dream"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient>
        <linearGradient id="grad-emerald-rush"><stop offset="0%" stop-color="#34d399"/><stop offset="100%" stop-color="#059669"/></linearGradient>
        <linearGradient id="grad-golden-spirit"><stop offset="0%" stop-color="#fcd34d"/><stop offset="100%" stop-color="#d97706"/></linearGradient>
        <!-- Gradients for newly added cars -->
        <linearGradient id="grad-lava-flow"><stop offset="0%" stop-color="#f97316"/><stop offset="100%" stop-color="#b91c1c"/></linearGradient>
        <linearGradient id="grad-arctic-chill"><stop offset="0%" stop-color="#bae6fd"/><stop offset="100%" stop-color="#0ea5e9"/></linearGradient>
        <linearGradient id="grad-solar-flare"><stop offset="0%" stop-color="#fde047"/><stop offset="100%" stop-color="#f59e0b"/></linearGradient>
        <!-- Admin-only car gradients -->
        <linearGradient id="grad-admin-dark-matter"><stop offset="0%" stop-color="#1a202c"/><stop offset="100%" stop-color="#4a5568"/></linearGradient>
        <linearGradient id="grad-admin-cosmic-ray"><stop offset="0%" stop-color="#805ad5"/><stop offset="100%" stop-color="#553c9a"/></linearGradient>
        <!-- Bot car gradients -->
        <linearGradient id="grad-bot-quanta"><stop offset="0%" stop-color="#a3a3a3"/><stop offset="100%" stop-color="#525252"/></linearGradient>
        <linearGradient id="grad-bot-johnny5"><stop offset="0%" stop-color="#ef4444"/><stop offset="100%" stop-color="#dc2626"/></linearGradient>
        <linearGradient id="grad-bot-siri"><stop offset="0%" stop-color="#67e8f9"/><stop offset="100%" stop-color="#06b6d4"/></linearGradient>
        <linearGradient id="grad-bot-elak"><stop offset="0%" stop-color="#facc15"/><stop offset="100%" stop-color="#eab308"/></linearGradient>
        <!-- New CORTEX bot gradient -->
        <linearGradient id="grad-bot-cortex"><stop offset="0%" stop-color="#e5e7eb"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient>
        <!-- 100 Procedurally Generated Gradients -->
        <g id="procedural-gradients"></g>
      </defs></svg>
    </div>

    <!-- Auth View -->
    <div id="auth-view" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="w-full max-w-sm card p-8">
            <!-- Logo and slogan added to the login page -->
            <div class="flex flex-col items-center justify-center mb-6">
                <h1 class="text-4xl font-logo text-slate-200 mt-2"><span class="logo-h">H</span>yper Type</h1>
                <p class="text-slate-400 text-sm mt-1">Type fast. Race hard. Win big.</p>
            </div>
            <h2 id="auth-title" class="text-3xl font-bold text-center mb-6 text-white">Log In</h2>
            <form id="auth-form" class="flex flex-col gap-4">
                <input id="auth-username" type="text" placeholder="Username" class="input" required>
                <input id="auth-password" type="password" placeholder="Password" class="input" required>
                <div id="auth-error" class="text-red-400 text-sm min-h-[2rem] text-center"></div>
                <button type="submit" id="auth-submit-btn" class="btn btn-primary">Log In</button>
            </form>
            <p class="text-center text-sm mt-4">
                <span id="auth-prompt">Need an account?</span>
                <button type="button" id="auth-toggle-btn" class="text-sky-400 hover:underline">Sign Up</button>
            </p>
        </div>
    </div>

    <!-- Main App View (hidden until logged in) -->
    <div id="app-view" class="hidden w-full min-h-screen flex-col">
        <header class="w-full bg-slate-900/80 backdrop-blur-sm shadow-lg z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center gap-4">
                        <h1 class="text-4xl font-logo text-slate-200"><span class="logo-h">H</span>yper Type</h1>
                    </div>
                    <div class="flex items-center gap-6">
                        <div id="player-cash" class="text-2xl font-bold text-green-400">$0</div>
                        <!-- Added race count display -->
                        <div id="player-races" class="text-2xl font-bold text-slate-300">Races: 0</div>
                        <button id="logout-btn" class="border-2 border-slate-600 hover:bg-slate-700 text-slate-200 font-bold py-2 px-6 rounded-lg transition-colors">Log Out</button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="nav-main w-full shadow-md z-10">
            <div class="max-w-7xl mx-auto flex justify-center">
                <!-- Race button is now active by default -->
                <button id="nav-race" class="nav-btn nav-race active">Race</button>
                <button id="nav-garage" class="nav-btn">Garage</button>
                <button id="nav-shop" class="nav-btn">Shop</button>
                <button id="nav-achievements" class="nav-btn">Achievements</button>
            </div>
        </nav>

        <main class="flex-grow flex items-center justify-center p-4 sm:p-6 lg:p-8">
            <div class="w-full max-w-7xl mx-auto">
                <div id="game-view" class="view"></div>
                <div id="garage-view" class="view"></div>
                <div id="shop-view" class="view"></div>
                <div id="achievements-view" class="view"></div>
            </div>
        </main>
    </div>

    <!-- Modal for Results (FIXED STRUCTURE) -->
    <div id="results-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="card p-8 text-center w-full max-w-md">
            <h2 id="results-title" class="text-4xl font-bold text-sky-400 mb-2">Race Finished!</h2>
            <div class="my-6 space-y-4">
                <p>WPM: <span id="final-wpm" class="text-6xl font-bold text-white">0</span></p>
                <p>Accuracy: <span id="final-accuracy" class="text-2xl font-bold">100%</span></p>
                <p>Cash Earned: <span id="final-cash" class="text-2xl font-bold text-green-400">$0</span></p>
                <div class="text-left mx-auto max-w-xs mt-4 text-slate-300 text-sm">
                    <p>Incorrectly Typed: <span id="final-incorrect-chars" class="font-bold">0</span></p>
                    <p>Time Taken: <span id="final-time-taken" class="font-bold">0s</span></p>
                    <h3 class="font-bold mt-4">Race Results:</h3>
                    <ul id="race-rankings" class="list-disc list-inside">
                        <!-- Rankings will be populated by JS -->
                    </ul>
                </div>
            </div>
            <div class="mt-8 flex justify-center gap-4">
                <button id="menu-btn" class="btn bg-slate-600 hover:bg-slate-700 text-white">Main Menu</button>
                <button id="restart-btn" class="btn btn-primary">Race Again</button>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://nmejryqbqwyapcryjdsn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZWpyeXFicXd5YXBjcnlqZHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMDE4NjQsImV4cCI6MjA2Nzc3Nzg2NH0.At5sZ8yUrVV84-GqcXKJpVE4p3k7QnX5C4Hl93p3zoU';
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Admin Users ---
        const adminUsers = ['varxual', 'slixinyg']; // Usernames that have admin privileges

        // --- Bot Definitions (UPDATED: Easier difficulty) ---
        const bots = [
            { name: 'Quanta', wpm: 30, accuracy: 85, car: 'forest_fury', special: false },
            { name: 'Johnny 5', wpm: 45, accuracy: 90, car: 'galaxy_gt', special: false },
            { name: 'Siri', wpm: 35, accuracy: 88, car: 'oceanic', special: false },
            { name: 'E-L-A-K bot', wpm: 60, accuracy: 92, car: 'solar_flare', special: true }, // E-L-A-K bot with special properties
            { name: 'CORTEX', wpm: 50, accuracy: 91, car: 'bot_cortex_car', special: false }, // New CORTEX bot
        ];
        const botNames = bots.map(bot => bot.name.toLowerCase());

        // --- Constants ---
        let carDesigns = {
            'firestorm': { price: 0, svg: (grad = 'url(#grad-fire)') => `<svg viewBox="0 0 200 90" class="car-svg-container"><path d="M68.3,1.7C40.8,1.7,18,16.2,18,43.7v2.5c0,6.9,5.6,12.5,12.5,12.5h139.1c6.9,0,12.5-5.6,12.5-12.5v-2.5 C182,16.2,159.2,1.7,131.7,1.7H68.3z" fill="${grad}"/><path d="M165.8,58.7H34.2c-5.5,0-10-4.5-10-10V33.3c0-5.5,4.5-10,10-10h131.7c5.5,0,10,4.5,10,10v15.4 C175.8,54.2,171.3,58.7,165.8,58.7z" fill="#000" opacity="0.3"/><path d="M129.2,28.3H70.8c-2.8,0-5,2.2-5,5v15.4c0,2.8,2.2,5,5,5h58.3c2.8,0,5-2.2,5-5V33.3 C134.2,30.5,131.9,28.3,129.2,28.3z" fill="#222"/><circle cx="38.3" cy="61.2" r="13.3" fill="#111"/><circle cx="161.7" cy="61.2" r="13.3" fill="#111"/></svg>` },
            'oceanic': 	{ price: 500, svg: () => carDesigns.firestorm.svg('url(#grad-ocean)') },
            'forest_fury': { price: 500, svg: () => carDesigns.firestorm.svg('url(#grad-forest)') },
            'galaxy_gt': { price: 1000, svg: () => carDesigns.firestorm.svg('url(#grad-galaxy)') },
            'purple_dream': { price: 1500, svg: () => carDesigns.firestorm.svg('url(#grad-purple-dream)') },
            'emerald_rush': { price: 2000, svg: () => carDesigns.firestorm.svg('url(#grad-emerald-rush)') },
            'golden_spirit': { price: 2500, svg: () => carDesigns.firestorm.svg('url(#grad-golden-spirit)') },
            'lava_flow': { price: 3000, svg: () => carDesigns.firestorm.svg('url(#grad-lava-flow)') },
            'arctic_chill': { price: 3500, svg: () => carDesigns.firestorm.svg('url(#grad-arctic-chill)') },
            'solar_flare': { price: 4000, svg: () => carDesigns.firestorm.svg('url(#grad-solar-flare)') },
            'dark_matter': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-admin-dark-matter)'), adminOnly: true },
            'cosmic_ray': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-admin-cosmic-ray)'), adminOnly: true },
            'bot_quanta_car': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-bot-quanta)') },
            'bot_johnny5_car': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-bot-johnny5)') },
            'bot_siri_car': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-bot-siri)') },
            'bot_elak_car': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-bot-elak)') },
            'bot_cortex_car': { price: 0, svg: () => carDesigns.firestorm.svg('url(#grad-bot-cortex)') },
        };
        // Filtered out sentences containing apostrophes
        const texts = [
            "The quick brown fox jumps over the lazy dog.",
            "Never underestimate the power of a good book.",
            "The early bird catches the worm.",
            "Technology has revolutionized the way we live and work.",
            "Creativity is intelligence having fun.",
            "The sun always shines brightest after the rain.",
            "A journey of a thousand miles begins with a single step.",
            "Innovation distinguishes between a leader and a follower.",
            "The greatest glory in living lies not in never falling, but in rising every time we fall.",
            "Life is what happens when you are busy making other plans.",
            "The future belongs to those who believe in the beauty of their dreams.",
            "Strive not to be a success, but rather to be of value.",
            "The only way to do great work is to love what you do.",
            "Believe you can and you are halfway there.",
            "The mind is everything. What you think you become.",
            "The best way to predict the future is to create it.",
            "Your time is limited, do not waste it living someone elses life.",
            "The unexamined life is not worth living.",
            "Where there is love, there is life.",
            "Do not go where the path may lead, go instead where there is no path and leave a trail.",
            "The only true wisdom is in knowing you know nothing.",
            "The journey is the reward.",
            "What we achieve inwardly will change outer reality.",
            "The darkest night is often the bridge to the brightest tomorrow.",
            "To be yourself in a world that is constantly trying to make you something else is the greatest accomplishment.",
            "The purpose of our lives is to be happy.",
            "You only live once, but if you do it right, once is enough.",
            "Many of lifes failures are people who did not realize how close they were to success when they gave up.",
            "If you want to live a happy life, tie it to a goal, not to people or things.",
            "Never let the fear of striking out keep you from playing the game.",
            "The secret of success is to do the common thing uncommonly well.",
            "I find that the harder I work, the more luck I seem to have.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "The only place where success comes before work is in the dictionary.",
            "Do not watch the clock; do what it does. Keep going.",
            "The future depends on what you do today.",
            "Quality is not an act, it is a habit.",
            "It is during our darkest moments that we must focus to see the light.",
            "The best revenge is massive success.",
            "To live is the rarest thing in the world. Most people just exist.",
            "The only limit to our realization of tomorrow will be our doubts of today.",
            "The measure of who we are is what we do with what we have.",
            "The mind is not a vessel to be filled, but a fire to be kindled.",
            "Happiness is not something ready made. It comes from your own actions.",
            "The only way to achieve the impossible is to believe it is possible.",
            "What lies behind us and what lies before us are tiny matters compared to what lies within us.",
            "The true sign of intelligence is not knowledge but imagination.",
            "The best and most beautiful things in the world cannot be seen or even touched - they must be felt with the heart.",
            "The only thing necessary for the triumph of evil is for good men to do nothing.",
            "Education is the most powerful weapon which you can use to change the world.",
            "The function of education is to teach one to think intensively and to think critically.",
            "Intelligence plus character - that is the goal of true education.",
            "The time is always right to do what is right.",
            "Darkness cannot drive out darkness; only light can do that.",
            "Hate cannot drive out hate; only love can do that.",
            "Injustice anywhere is a threat to justice everywhere.",
            "Our lives begin to end the day we become silent about things that matter.",
            "The ultimate measure of a man is not where he stands in moments of comfort and convenience, but where he stands at times of challenge and controversy.",
            "Peace is not merely a distant goal that we seek, but a means by which we arrive at that goal.",
            "True peace is not merely the absence of tension: it is the presence of justice.",
            "The arc of the moral universe is long, but it bends toward justice.",
            "I have a dream that one day this nation will rise up and live out the true meaning of its creed.",
            "Let freedom ring from the prodigious hilltops of New Hampshire.",
            "From every mountainside, let freedom ring.",
            "When we allow freedom to ring, when we let it ring from every village and every hamlet, from every state and every city, we will be able to speed up that day when all of Gods children, black men and white men, Jews and Gentiles, Protestants and Catholics, will be able to join hands and sing in the words of the old Negro spiritual: Free at last! Free at last! Thank God Almighty, we are free at last!",
            "The only thing we have to fear is fear itself.",
            "The only way out is through.",
            "If you want to know what a mans like, take a good look at how he treats his inferiors, not his equals.",
            "It is a curious thought, but it is only when you see people looking ridiculous that you realize just how much you love them.",
            "The truth is rarely pure and never simple.",
            "All animals are equal, but some animals are more equal than others.",
            "Big Brother is watching you.",
            "War is peace. Freedom is slavery. Ignorance is strength.",
            "The past is dead. The future is unimaginable.",
            "Who controls the past controls the future. Who controls the present controls the past.",
            "Doublethink means the power of holding two contradictory beliefs in ones mind simultaneously, and accepting both of them.",
            "The best books are those that tell you what you know already.",
            "It was a bright cold day in April, and the clocks were striking thirteen.",
            "He who controls the spice controls the universe.",
            "Fear is the mind-killer.",
            "I must not fear. Fear is the little-death that brings total obliteration.",
            "The sleeper must awaken.",
            "There is no escape. We are all part of the same great machine.",
            "The slow blade penetrates the shield.",
            "The mystery of life is not a problem to be solved, but a reality to be experienced.",
            "The mind can make a heaven of hell, or a hell of heaven.",
            "We are what we pretend to be, so we must be careful what we pretend to be.",
            "The earth is a very small stage in a vast cosmic arena.",
            "Look again at that dot. Thats here. Thats home. Thats us.",
            "On it everyone you love, everyone you know, everyone you ever heard of, every human being who ever was, lived out their lives.",
            "The aggregate of our joy and suffering, thousands of confident religions, ideologies, and economic doctrines, every hunter and forager, every hero and coward, every creator and destroyer of civilization, every king and peasant, every young couple in love, every mother and father, hopeful child, inventor and explorer, every teacher of morals, every corrupt politician, every superstar, every supreme leader, every saint and sinner in the history of our species lived there-on a mote of dust suspended in a sunbeam.",
            "The cosmos is all that is or ever was or ever will be.",
            "Our loyalties are to the species and the planet.",
            "We are a way for the cosmos to know itself.",
            "Science is a way of thinking much more than it is a body of knowledge.",
            "Extraordinary claims require extraordinary evidence.",
            "The nitrogen in our DNA, the calcium in our teeth, the iron in our blood, the carbon in our apple pies were made in the interiors of collapsing stars.",
            "We are made of starstuff.",
            "The universe is not obliged to make sense to you.",
            "The greatest enemy of knowledge is not ignorance, it is the illusion of knowledge.",
            "If you wish to make an apple pie from scratch, you must first invent the universe.",
            "Everything is connected. Nothing is truly separate.",
            "The only constant in life is change.",
            "To err is human; to forgive, divine.",
            "Actions speak louder than words.",
            "When in Rome, do as the Romans do.",
            "Beggars cant be choosers.",
            "Cleanliness is next to godliness.",
            "Do not put all your eggs in one basket.",
            "Every cloud has a silver lining.",
            "Haste makes waste.",
            "Ignorance is bliss.",
            "Kill two birds with one stone.",
            "Look before you leap.",
            "Necessity is the mother of invention.",
            "Practice makes perfect.",
            "Rome wasnt built in a day.",
            "Still waters run deep.",
            "The early bird catches the worm.",
            "There is no place like home.",
            "When the going gets tough, the tough get going.",
            "You cannot judge a book by its cover.",
            "A penny saved is a penny earned.",
            "All that glitters is not gold.",
            "An apple a day keeps the doctor away.",
            "Better late than never.",
            "Curiosity killed the cat.",
            "Do not bite the hand that feeds you.",
            "Easy come, easy go.",
            "Fortune favors the bold.",
            "Good things come to those who wait.",
            "Honesty is the best policy.",
            "Its a small world after all.",
            "Laughter is the best medicine.",
            "No pain, no gain.",
            "Out of sight, out of mind.",
            "Revenge is a dish best served cold.",
            "Strike while the iron is hot.",
            "The grass is always greener on the other side.",
            "Time heals all wounds.",
            "Where there is a will, there is a way.",
            "You cannot have your cake and eat it too.",
            "A bird in the hand is worth two in the bush.",
            "All is well that ends well.",
            "Beauty is in the eye of the beholder.",
            "Birds of a feather flock together.",
            "Do not count your chickens before they hatch.",
            "Every dog has its day.",
            "Familiarity breeds contempt.",
            "Great minds think alike.",
            "If it aint broke, do not fix it.",
            "It takes two to tango.",
            "Knowledge is power.",
            "Many hands make light work.",
            "One mans trash is another mans treasure.",
            "Patience is a virtue.",
            "Seeing is believing.",
            "The pen is mightier than the sword.",
            "There is no such thing as a free lunch.",
            "When one door closes, another one opens.",
            "You reap what you sow.",
            "A chain is only as strong as its weakest link.",
            "Absence makes the heart grow fonder.",
            "Beggars cant be choosers.",
            "Better safe than sorry.",
            "Cleanliness is next to godliness.",
            "Do not cry over spilled milk.",
            "Every rose has its thorn.",
            "Fine words butter no parsnips.",
            "God helps those who help themselves.",
            "If you cannot stand the heat, get out of the kitchen.",
            "Its better to be safe than sorry.",
            "Keep your friends close and your enemies closer.",
            "Look before you leap.",
            "Never put off until tomorrow what you can do today.",
            "Opportunity knocks but once.",
            "Practice what you preach.",
            "Put your money where your mouth is.",
            "Rome wasnt built in a day.",
            "Still waters run deep.",
            "The squeaky wheel gets the grease.",
            "There is no time like the present.",
            "Two heads are better than one.",
            "When the cats away, the mice will play.",
            "You can lead a horse to water, but you cannot make him drink.",
            "A rolling stone gathers no moss.",
            "All good things must come to an end.",
            "Bad news travels fast.",
            "Birds of a feather flock together.",
            "Cut your coat according to your cloth.",
            "Do not count your chickens before they hatch.",
            "Early to bed and early to rise makes a man healthy, wealthy, and wise.",
            "Every dark cloud has a silver lining.",
            "First come, first served.",
            "Give a man a fish and you feed him for a day; teach a man to fish and you feed him for a lifetime.",
            "Hindsight is twenty-twenty.",
            "If you play with fire, you will get burned.",
            "Its never too late to mend.",
            "Keep your chin up.",
            "Lightning never strikes twice in the same place.",
            "Many hands make light work.",
            "No news is good news.",
            "Old habits die hard.",
            "Patience is a virtue.",
            "Penny wise, pound foolish.",
            "Put your best foot forward.",
            "Seeing is believing.",
            "The more, the merrier.",
            "There is no accounting for taste.",
            "Two wrongs do not make a right.",
            "When in doubt, do nothing.",
            "You cannot teach an old dog new tricks.",
            "A stitch in time saves nine.",
            "All is fair in love and war.",
            "Better late than never.",
            "Blood is thicker than water.",
            "Curiosity killed the cat.",
            "Do not cross your bridges before you come to them.",
            "Eat, drink, and be merry, for tomorrow we die.",
            "Every man has his price.",
            "Fools rush in where angels fear to tread.",
            "Great minds think alike.",
            "If you cannot beat em, join em.",
            "Its a piece of cake.",
            "Keep your powder dry.",
            "Live and learn.",
            "Might makes right.",
            "Nothing ventured, nothing gained.",
            "Once bitten, twice shy.",
            "Practice makes perfect.",
            "Put yourself in someone elses shoes.",
            "Silence is golden.",
            "The proof of the pudding is in the eating.",
            "There is no fool like an old fool.",
            "Variety is the spice of life.",
            "When the going gets tough, the tough get going.",
            "You cannot win em all.",
            "A friend in need is a friend indeed.",
            "An ounce of prevention is worth a pound of cure.",
            "Beauty is only skin deep.",
            "Birds of a feather flock together.",
            "Cleanliness is next to godliness.",
            "Do not count your chickens before they hatch.",
            "Early bird catches the worm.",
            "Every cloud has a silver lining.",
            "Familiarity breeds contempt.",
            "Good things come to those who wait.",
            "Honesty is the best policy.",
            "If you want something done right, do it yourself.",
            "Its better to give than to receive.",
            "Keep your head above water.",
            "Look before you leap.",
            "Necessity is the mother of invention.",
            "One mans trash is another mans treasure.",
            "Patience is a virtue.",
            "Rome wasnt built in a day.",
            "Still waters run deep.",
            "The grass is always greener on the other side.",
            "Time is money.",
            "Where there is smoke, there is fire.",
            "You cannot teach an old dog new tricks.",
            "A picture is worth a thousand words.",
            "All is well that ends well.",
            "Better safe than sorry.",
            "Charity begins at home.",
            "Do not put all your eggs in one basket.",
            "Every dog has its day.",
            "Fortune favors the bold.",
            "Haste makes waste.",
            "Ignorance is bliss.",
            "Its a long road that has no turning.",
            "Laughter is the best medicine.",
            "Many hands make light work.",
            "No pain, no gain.",
            "Out of sight, out of mind.",
            "Revenge is a dish best served cold.",
            "The early bird catches the worm.",
            "There is no place like home.",
            "When in Rome, do as the Romans do.",
            "You reap what you sow.",
            "A bad workman blames his tools.",
            "Actions speak louder than words.",
            "Barking dogs seldom bite.",
            "Beggars cant be choosers.",
            "Do not throw the baby out with the bathwater.",
            "Every man has his faults.",
            "Faint heart never won fair lady.",
            "God helps those who help themselves.",
            "If at first you do not succeed, try, try again.",
            "Its an ill wind that blows nobody any good.",
            "Keep up with the Joneses.",
            "Least said, soonest mended.",
            "Misery loves company.",
            "No news is good news.",
            "One good turn deserves another.",
            "Practice makes perfect.",
            "The customer is always right.",
            "The pen is mightier than the sword.",
            "There is no such thing as a free lunch.",
            "Two heads are better than one.",
            "When the cats away, the mice will play.",
            "You cannot make an omelette without breaking eggs."
        ];
        let achievements = {
            'first_race': { name: 'First Race!', description: 'Complete your first race.' },
            'wpm_50': { name: 'Speedster', description: 'Reach 50 WPM in a race.' },
            'cash_1000': { name: 'High Roller', description: 'Earn over $1000 total.' },
            'wpm_75': { name: 'Nitro Boost', description: 'Reach 75 WPM in a race.' },
            'accuracy_98': { name: 'Precision Driver', description: 'Achieve 98%+ accuracy in a race.' },
            'races_10': { name: 'Dedicated Racer', description: 'Complete 10 races.' },
            'all_cars': { name: 'Car Collector', description: 'Own all available cars.' },
            'races_25': { name: 'Veteran Racer', description: 'Complete 25 races.' },
            'cash_5000': { name: 'Tycoon', description: 'Earn over $5000 total.' },
            'wpm_100': { name: 'Untouchable', description: 'Reach 100 WPM in a race.' },
            'perfect_accuracy': { name: 'Flawless Run', description: 'Achieve 100% accuracy in a race.' },
            'races_50': { name: 'Legendary Driver', description: 'Complete 50 races.' },
            'races_100': { name: 'Grand Master', description: 'Complete 100 races.' },
            'cash_10000': { name: 'Millionaire Mindset', description: 'Earn over $10,000 total.' },
            'wpm_120': { name: 'Supersonic', description: 'Reach 120 WPM in a race.' },
            'all_achievements': { name: 'Completionist', description: 'Unlock all achievements.' }
        };

        // --- Procedural Content Generation ---
        function generateProceduralContent() {
            const carAdjectives = ["Crimson", "Azure", "Jade", "Gilded", "Obsidian", "Cobalt", "Amber", "Ivory", "Scarlet", "Violet", "Onyx", "Silver", "Bronze", "Ruby", "Emerald", "Sapphire", "Diamond", "Quartz", "Granite", "Marble", "Slate", "Cosmic", "Galactic", "Nebula", "Stardust", "Solar", "Lunar", "Quantum", "Phantom", "Shadow", "Ghost", "Spirit", "Wraith", "Spectre", "Blaze", "Inferno", "Vortex", "Tempest", "Cyclone", "Hurricane", "Tsunami", "Avalanche", "Blitz", "Comet", "Meteor", "Pulsar", "Quasar", "Supernova", "Viper", "Cobra"];
            const carNouns = ["Fury", "Striker", "Glider", "Racer", "Drifter", "Prowler", "Interceptor", "Vindicator", "Avenger", "Juggernaut", "Behemoth", "Leviathan", "Colossus", "Titan", "Goliath", "Charger", "Challenger", "Vanquisher", "Conqueror", "Slayer", "Hunter", "Stalker", "Predator", "Reaper", "Harbinger", "Omen", "Prophet", "Oracle", "Sorcerer", "Wizard", "Warlock", "Mage", "Enchanter", "Alchemist", "Artisan", "Craftsman", "Smith", "Wright", "Builder", "Architect", "Engineer", "Inventor", "Pioneer", "Explorer", "Voyager", "Traveler", "Wanderer", "Nomad", "Pilgrim", "Crusader"];
            const gradientsContainer = document.getElementById('procedural-gradients');
            let gradientsHTML = '';
            let lastPrice = 4000;

            for (let i = 0; i < 100; i++) {
                const adj = carAdjectives[Math.floor(Math.random() * carAdjectives.length)];
                const noun = carNouns[Math.floor(Math.random() * carNouns.length)];
                const name = `${adj} ${noun}`;
                const key = name.toLowerCase().replace(/\s+/g, '_');

                if (carDesigns[key]) continue; // Avoid duplicates

                lastPrice += Math.floor(Math.random() * 500) + 250; // Increment price by 250-750
                const color1 = `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                const color2 = `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
                const gradId = `grad-${key}`;

                gradientsHTML += `<linearGradient id="${gradId}"><stop offset="0%" stop-color="${color1}"/><stop offset="100%" stop-color="${color2}"/></linearGradient>`;
                
                carDesigns[key] = {
                    price: lastPrice,
                    svg: () => carDesigns.firestorm.svg(`url(#${gradId})`)
                };
            }
            if (gradientsContainer) {
                gradientsContainer.innerHTML = gradientsHTML;
            }

            // Add new achievements
            Object.assign(achievements, {
                'races_250': { name: 'Hyper Racer', description: 'Complete 250 races.' },
                'races_500': { name: 'Supreme Racer', description: 'Complete 500 races.' },
                'cash_50k': { name: 'Wealthy', description: 'Earn over $50,000 total.' },
                'cash_100k': { name: 'Filthy Rich', description: 'Earn over $100,000 total.' },
                'cash_1m': { name: 'Millionaire', description: 'Earn over $1,000,000 total.' },
                'wpm_150': { name: 'Lightspeed', description: 'Reach 150 WPM in a race.' },
                'wpm_200': { name: 'Godlike', description: 'Reach 200 WPM in a race.' },
                'car_collector_50': { name: 'Garage Owner', description: 'Own 50 cars.' },
                'car_collector_100': { name: 'Showroom Baron', description: 'Own 100 cars.' }
            });
        }

        // --- Profanity Filter ---
        const profaneWords = ['fuck', 'shit', 'bitch', 'asshole', 'cunt', 'damn', 'hell', 'piss', 'dick', 'cock', 'slut', 'whore', 'bastard'];

        function containsProfanity(text) {
            const lowerCaseText = text.toLowerCase();
            return profaneWords.some(word => lowerCaseText.includes(word));
        }

        // --- Global State ---
        let player = {};
        let gameState = {};
        let mysteryBoxInterval = null;
        let inactivityTimer = null; // New timer for inactivity

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const authForm = document.getElementById('auth-form');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authErrorEl = document.getElementById('auth-error');
        const authUsernameInput = document.getElementById('auth-username');

        // --- Supabase Auth ---
        let isLoginMode = true;

        authToggleBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').textContent = isLoginMode ? 'Log In' : 'Sign Up';
            document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Log In' : 'Sign Up';
            document.getElementById('auth-prompt').textContent = isLoginMode ? 'Need an account?' : 'Already have an account?';
            authToggleBtn.textContent = isLoginMode ? 'Sign Up' : 'Log In';
            authErrorEl.innerHTML = '';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = authUsernameInput.value.trim().toLowerCase();
            const password = document.getElementById('auth-password').value;
            authErrorEl.innerHTML = '';

            if (!username || !password) {
                authErrorEl.textContent = "Username and password are required.";
                return;
            }

            // Profanity filter for username
            if (containsProfanity(username)) {
                authErrorEl.textContent = "Username contains inappropriate language. Please choose a different one.";
                return;
            }

            // Prevent registration with bot names
            if (botNames.includes(username)) {
                authErrorEl.textContent = `The username "${username}" is reserved for a bot. Please choose a different one.`;
                return;
            }

            const email = `${username}@hypertype.game`;

            try {
                if (isLoginMode) {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) {
                        if (error.message.includes("Invalid login credentials")) {
                            throw new Error("No account with that username or password found.");
                        }
                        throw error;
                    }
                } else {
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                username: username,
                                display_name: username,
                            }
                        }
                    });
                    if (error) {
                            if (error.message.includes("User already registered")) {
                                throw new Error("Username is already taken.");
                            }
                            throw error;
                    }
                }
            } catch (error) {
                authErrorEl.textContent = error.message;
            }
        });

        async function createPublicProfile(user, username) {
            // Add admin-only cars to owned_cars if the user is an admin
            const initialOwnedCars = ['firestorm'];
            if (adminUsers.includes(username)) {
                for (const carKey in carDesigns) {
                    if (carDesigns[carKey].adminOnly && !initialOwnedCars.includes(carKey)) {
                        initialOwnedCars.push(carKey);
                    }
                }
            }

            const { error } = await supabaseClient.from('users').insert({
                id: user.id,
                username: username,
                car: 'firestorm', // Default car
                cash: 250,
                owned_cars: initialOwnedCars,
                achievements: [],
                stats: { totalRaces: 0, highestWpm: 0 },
                last_mystery_box_claim: new Date(0).toISOString()
            });
            if (error) {
                console.error("Error creating public profile:", error);
                authErrorEl.textContent = "Error creating profile. Please try again.";
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
        });

        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (session?.user) {
                const user = session.user;
                authErrorEl.innerHTML = '<span>Loading player data...</span>';
                try {
                    await loadPlayerData(user);
                    authView.classList.add('hidden');
                    appView.style.display = 'flex';
                    await initializeGame();
                    // Explicitly show garage view after initialization for quick loading
                    activateAndRenderView('garage-view'); // Use new function for quick loading
                    authErrorEl.innerHTML = '';
                } catch (error) {
                    console.error("Error loading player data:", error);
                    authErrorEl.textContent = "Could not load player data. Did you run the SQL setup?";
                    await supabaseClient.auth.signOut();
                }
            } else {
                authView.classList.remove('hidden');
                appView.style.display = 'none';
                authErrorEl.innerHTML = '';
            }
        });

        // --- Data Management ---
        async function loadPlayerData(user) {
            const { data, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', user.id);

            if (error) throw error;

            if (data && data.length > 0) {
                player = data[0];
                // Ensure admin users own admin-only cars if they don't already
                if (adminUsers.includes(player.username)) {
                    let updatedOwnedCars = [...player.owned_cars];
                    let changed = false;
                    for (const carKey in carDesigns) {
                        if (carDesigns[carKey].adminOnly && !updatedOwnedCars.includes(carKey)) {
                            updatedOwnedCars.push(carKey);
                            changed = true;
                        }
                    }
                    if (changed) {
                        player.owned_cars = updatedOwnedCars;
                        await updatePlayerOnDb(); // Save updated owned cars to DB
                    }
                }
            } else {
                const username = user.user_metadata.username || user.email.split('@')[0];
                await createPublicProfile(user, username);
                const { data: newData, error: newError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                if (newError) throw newError;
                player = newData;
            }
        }

        async function updatePlayerOnDb() {
            if (!player || !player.id) return;
            const { id, ...playerData } = player;
            const { error } = await supabaseClient
                .from('users')
                .update(playerData)
                .eq('id', id);
            if (error) console.error("Error updating player data:", error);
        }

        // --- Game Initialization & View Management ---
        async function initializeGame() {
            generateProceduralContent(); // Generate cars and achievements on load
            document.getElementById('player-cash').textContent = `$${player.cash}`;
            // Update race count display on initialization
            document.getElementById('player-races').textContent = `Races: ${player.stats.totalRaces || 0}`;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', (e) => {
                // Remove active class from all nav buttons
                document.querySelectorAll('.nav-btn').forEach(navBtn => navBtn.classList.remove('active'));
                // Add active class to the clicked button
                e.target.classList.add('active');
                handleNavClick(e.target.id);
            }));
            document.getElementById('restart-btn')?.addEventListener('click', () => {
                const resultsModal = document.getElementById('results-modal');
                if (resultsModal) resultsModal.classList.add('hidden');
                startGame();
            });
            document.getElementById('menu-btn')?.addEventListener('click', () => {
                const resultsModal = document.getElementById('results-modal');
                if (resultsModal) resultsModal.classList.add('hidden');
                showView('garage-view');
            });
            document.addEventListener('keydown', handleTyping);
            await setupViews();
            resetGame();
        }

        function handleNavClick(navId) {
            const viewId = navId.replace('nav-', '') + '-view';
            if (viewId === 'race-view') {
                 showView('game-view');
                 startGame();
            } else {
                showView(viewId);
            }
        }

        function showView(viewId) {
            // Check if game is active and user is trying to switch away from game view
            if (gameState.gameActive && viewId !== 'game-view') {
                showMessageBox("Leave the current race? Your progress will be lost.", () => {
                    // User confirmed to leave, reset game and activate new view
                    resetGame();
                    activateAndRenderView(viewId);
                }, true); // Pass true to indicate it's a confirmation
                return;
            }
            // If game is not active or switching to game view, just activate and render
            activateAndRenderView(viewId);
        }

        async function activateAndRenderView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn) { // Null check for btn
                    btn.classList.remove('active');
                    if (btn.id === `nav-${viewId.replace('-view', '')}`) {
                        btn.classList.add('active');
                    }
                }
            });

            // Render content for the activated view
            if (viewId === 'garage-view') {
                updateGarageDashboard();
            } else if (viewId === 'shop-view') {
                await updateShop();
            } else if (viewId === 'achievements-view') {
                await updateAchievements();
            }
            // No specific rendering needed for 'game-view' as it's handled by startGame/resetGame
        }


        async function setupViews() {
            // Initial game view structure, now with dynamic bot lanes
            document.getElementById('game-view').innerHTML = `
                <div class="w-full max-w-4xl mx-auto flex flex-col gap-8">
                    <div id="race-track" class="w-full card p-4 relative overflow-hidden">
                        <div class="lane" id="player-lane">
                            <span class="lane-label">${player.username}</span>
                            <div id="player-car" class="car absolute" style="left: 1%;"></div>
                        </div>
                        <div id="bot-lanes-container" class="flex flex-col justify-around flex-grow">
                            <!-- Bot lanes will be dynamically added here -->
                        </div>
                        <div class="absolute top-0 right-4 h-full w-2 bg-repeat-y" style="background-image: linear-gradient(to bottom, white 50%, black 50%); background-size: 100% 20px;"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="card p-4"><p class="text-slate-400 text-sm">WPM</p><p id="wpm" class="text-3xl font-bold">--</p></div>
                        <div class="card p-4"><p class="text-slate-400 text-sm">Accuracy</p><p id="accuracy" class="text-3xl font-bold">--</p></div>
                    </div>
                    <div class="card p-6 font-mono text-slate-400 select-none text-2xl tracking-wider min-h-[100px]">
                        <div id="text-display" class="text-left">Click 'Race' to start!</div>
                    </div>
                </div>
            `;
        }

        // --- Garage Dashboard ---
        function updateGarageDashboard() {
            const container = document.getElementById('garage-view');
            if (!container) return; // Null check

            const totalXP = (player.stats.totalRaces || 0) * 25;
            const level = Math.floor(Math.sqrt(totalXP / 100)) + 1;
            const xpForNextLevel = Math.pow(level, 2) * 100;
            const xpForCurrentLevel = Math.pow(level - 1, 2) * 100;
            const xpInCurrentLevel = totalXP - xpForCurrentLevel;
            const xpNeededForNext = xpForNextLevel - xpForCurrentLevel;
            const xpPercentage = Math.min((xpInCurrentLevel / xpNeededForNext) * 100, 100);

            let league = 'Bronze';
            if (level >= 10) league = 'Silver';
            if (level >= 25) league = 'Gold';
            if (level >= 50) league = 'Platinum';

            const isAdmin = adminUsers.includes(player.username);
            let adminControlsHtml = '';
            if (isAdmin) {
                adminControlsHtml = `
                    <div class="space-y-3">
                        <h3 class="font-bold text-lg text-amber-400">Admin Controls</h3>
                        <div class="flex gap-2">
                            <input id="admin-races-input" type="number" placeholder="Set Races" class="input flex-grow" min="0">
                            <button id="set-races-btn" class="btn bg-red-500 hover:bg-red-600">Set Races</button>
                        </div>
                        <div class="flex gap-2">
                            <input id="admin-cash-input" type="number" placeholder="Give Cash" class="input flex-grow" min="0">
                            <button id="give-cash-btn" class="btn bg-green-500 hover:bg-green-600">Give Cash</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div id="user-info-panel">
                            <h2 class="text-3xl font-bold text-white">${player.username} ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}</h2>
                            <p class="text-sky-400">${league} League</p>
                        </div>
                        <div class="space-y-3">
                            <button id="garage-race-now" class="btn btn-danger w-full text-lg">Race Now</button>
                        </div>
                        ${adminControlsHtml}
                        <div id="mystery-box-card" class="card p-4"></div>
                        <div class="card p-4">
                            <h3 class="font-bold mb-2">CASH</h3>
                            <p class="text-2xl font-bold text-green-400">$${player.cash}</p>
                        </div>
                    </div>
                    <div class="lg:col-span-1 flex flex-col items-center justify-center space-y-4">
                        <div id="main-car-display" class="w-full h-64 flex items-center justify-center">
                            <div class="transform scale-150 -rotate-12">
                                ${carDesigns[player.car || 'firestorm'].svg()}
                            </div>
                        </div>
                        <button id="customize-btn" class="btn bg-slate-700 hover:bg-slate-600">Customize Cars & Loot</button>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold">Level ${level}</h3>
                            </div>
                            <div class="progress-bar h-4 w-full">
                                <div class="progress-bar-inner" style="width: ${xpPercentage}%;"></div>
                            </div>
                            <p class="text-xs text-slate-400 text-center mt-1">${xpInCurrentLevel.toFixed(0)} / ${xpNeededForNext.toFixed(0)} XP</p>
                        </div>
                        <div class="card p-2 flex items-center gap-2">
                            <div class="w-24 h-12 bg-slate-900 rounded flex items-center justify-center">
                                ${carDesigns[player.car || 'firestorm'].svg()}
                            </div>
                            <p class="font-bold text-sm">CAR</p>
                        </div>
                        <div class="card p-4">
                            <h3 class="font-bold mb-2">Daily Challenges</h3>
                            <div class="space-y-3 text-sm">
                                <p>Complete 10 Races (${player.stats.totalRaces}/10)</p>
                                <p>8 Races 1st-3rd Place (0/8)</p>
                                <p>9 Races with 96%+ Accuracy (0/9)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('garage-race-now')?.addEventListener('click', () => startGame());
            document.getElementById('customize-btn')?.addEventListener('click', () => showView('shop-view'));
            
            if (isAdmin) {
                document.getElementById('set-races-btn')?.addEventListener('click', async () => {
                    const racesInput = document.getElementById('admin-races-input');
                    const numRaces = parseInt(racesInput?.value);
                    if (!isNaN(numRaces) && numRaces >= 0) {
                        player.stats.totalRaces = numRaces;
                        await updatePlayerOnDb();
                        const playerRacesEl = document.getElementById('player-races');
                        if (playerRacesEl) playerRacesEl.textContent = `Races: ${player.stats.totalRaces}`;
                        updateGarageDashboard(); // Re-render garage to update level/XP
                        updateAchievements(); // Re-check achievements
                        showMessageBox(`Total races set to ${numRaces}!`);
                        if (racesInput) racesInput.value = '';
                    } else {
                        showMessageBox("Please enter a valid number for races.");
                    }
                });

                document.getElementById('give-cash-btn')?.addEventListener('click', async () => {
                    const cashInput = document.getElementById('admin-cash-input');
                    const amount = parseInt(cashInput?.value);
                    if (!isNaN(amount) && amount >= 0) {
                        player.cash += amount;
                        await updatePlayerOnDb();
                        const playerCashEl = document.getElementById('player-cash');
                        if (playerCashEl) playerCashEl.textContent = `$${player.cash}`;
                        updateGarageDashboard(); // Re-render garage to update cash
                        updateAchievements(); // Re-check achievements
                        showMessageBox(`Given $${amount} cash! Total: $${player.cash}`);
                        if (cashInput) cashInput.value = '';
                    } else {
                        showMessageBox("Please enter a valid amount for cash.");
                    }
                });
            }
            updateMysteryBox();
        }

        function updateMysteryBox() {
            const card = document.getElementById('mystery-box-card');
            if (!card) return; // Null check
            const lastClaim = new Date(player.last_mystery_box_claim || 0);
            const now = new Date();
            const threeHours = 3 * 60 * 60 * 1000;
            const timeSinceClaim = now - lastClaim;

            if (timeSinceClaim >= threeHours) {
                card.innerHTML = `
                    <h3 class="font-bold mb-2">Mystery Box</h3>
                    <p class="text-slate-400 text-sm">Ready to claim!</p>
                    <button id="claim-mystery-box" class="btn btn-primary w-full mt-2">Claim Now</button>
                `;
                document.getElementById('claim-mystery-box')?.addEventListener('click', async () => {
                    const cashWon = Math.floor(Math.random() * 29001) + 1000; // Generates a number between 1000 and 30000
                    player.cash += cashWon;
                    player.last_mystery_box_claim = new Date().toISOString();
                    await updatePlayerOnDb();
                    const playerCashEl = document.getElementById('player-cash');
                    if (playerCashEl) playerCashEl.textContent = `$${player.cash}`;
                    // Replaced alert with a custom message box
                    showMessageBox(`You won $${cashWon}!`);
                    updateMysteryBox();
                });
            } else {
                if (mysteryBoxInterval) clearInterval(mysteryBoxInterval);

                const updateCountdown = () => {
                    const remainingTime = threeHours - (new Date() - new Date(player.last_mystery_box_claim));
                    if (remainingTime <= 0) {
                        clearInterval(mysteryBoxInterval);
                        updateMysteryBox();
                        return;
                    }
                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                    card.innerHTML = `
                        <h3 class="font-bold mb-2">Mystery Box</h3>
                        <p class="text-slate-400 text-sm">Arriving in...</p>
                        <p class="text-2xl font-bold">${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</p>
                    `;
                };
                updateCountdown();
                mysteryBoxInterval = setInterval(updateCountdown, 1000);
            }
        }

        // Custom Message Box function
        // Added optional callback and isConfirm parameter to showMessageBox
        function showMessageBox(message, callback = null, isConfirm = false) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]';
            modal.innerHTML = `
                <div class="card p-8 text-center w-full max-w-sm">
                    <p class="text-xl font-bold text-white mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="message-box-ok" class="btn btn-primary">OK</button>
                        ${isConfirm ? '<button id="message-box-cancel" class="btn bg-slate-600 hover:bg-slate-700 text-white">Cancel</button>' : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('message-box-ok')?.addEventListener('click', () => {
                document.body.removeChild(modal);
                if (callback) callback();
            });

            if (isConfirm) {
                document.getElementById('message-box-cancel')?.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }
        }


        // --- Feature Updates (Shop, Friends, etc.) ---
        async function updateShop() {
            const container = document.getElementById('shop-view');
            if (!container) return; // Null check
            container.innerHTML = `<div class="card p-8"><h2 class="text-3xl font-bold text-center mb-6">Car Shop</h2><div id="shop-cars" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>`;
            const shopContainer = container.querySelector('#shop-cars');
            if (!shopContainer) return; // Null check

            const isAdmin = adminUsers.includes(player.username);

            Object.keys(carDesigns).forEach(carKey => {
                const carInfo = carDesigns[carKey];
                // Only show admin-only cars to admins
                if (carInfo.adminOnly && !isAdmin) {
                    return;
                }
                // Do not show bot cars in the shop
                if (carKey.startsWith('bot_')) {
                    return;
                }

                const isOwned = player.owned_cars.includes(carKey);
                const isEquipped = player.car === carKey;
                const canAfford = player.cash >= carInfo.price;
                const carDiv = document.createElement('div');
                carDiv.className = 'card p-4 flex flex-col items-center gap-4';
                let buttonHtml = '';
                if (isEquipped) {
                    buttonHtml = '<button class="btn btn-disabled" disabled>Equipped</button>';
                } else if (isOwned) {
                    buttonHtml = `<button class="btn btn-primary select-car-btn" data-car-key="${carKey}">Select</button>`;
                } else {
                    buttonHtml = `<button class="btn ${canAfford || carInfo.adminOnly ? 'btn-primary' : 'btn-disabled'}" ${(!canAfford && !carInfo.adminOnly) ? 'disabled' : ''}>${carInfo.adminOnly ? 'Admin Only' : `$${carInfo.price}`}</button>`;
                }

                carDiv.innerHTML = `${carInfo.svg()}<p class="font-bold text-lg capitalize">${carKey.replace(/_/g, ' ')}</p>${buttonHtml}`;

                const button = carDiv.querySelector('button');
                if (button) { // Null check for button
                    if (!isOwned && (canAfford || carInfo.adminOnly)) { // Allow admins to get their cars for free
                        button.addEventListener('click', async () => {
                            if (!carInfo.adminOnly) { // Only deduct cash if not an admin car
                                player.cash -= carInfo.price;
                            }
                            player.owned_cars.push(carKey);
                            await updatePlayerOnDb();
                            const playerCashEl = document.getElementById('player-cash');
                            if (playerCashEl) playerCashEl.textContent = `$${player.cash}`;
                            await updateShop(); // Re-render shop to update button states
                        });
                    } else if (isOwned && !isEquipped) {
                        button.addEventListener('click', async (e) => {
                            const selectedCarKey = e.target.dataset.carKey;
                            player.car = selectedCarKey;
                            await updatePlayerOnDb();
                            await updateShop(); // Re-render shop to update equipped car
                            updateGarageDashboard(); // Update car display in garage
                        });
                    }
                }
                shopContainer.appendChild(carDiv);
            });
        }

        async function updateAchievements() {
            const container = document.getElementById('achievements-view');
            if (!container) return; // Null check
            let achievementHTML = '<div class="card p-8"><h2 class="text-3xl font-bold text-center mb-6">Achievements</h2><div class="space-y-4">';
            if(!player.achievements) player.achievements = [];
            for (const id in achievements) {
                const isUnlocked = player.achievements.includes(id);
                achievementHTML += `<div class="card p-4 ${isUnlocked ? 'border-green-400' : 'opacity-60'}"><h3 class="font-bold text-lg">${achievements[id].name} ${isUnlocked ? '' : ''}</h3><p class="text-sm text-slate-400">${achievements[id].description}</p></div>`;
            }
            achievementHTML += '</div></div>';
            container.innerHTML = achievementHTML;
        }

        // --- Game Logic ---
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function startGame() {
            showView('game-view');
            if (gameState.gameActive || gameState.countdownActive) return;
            resetGame();
            gameState.countdownActive = true;
            initializeBotsForRace(); // Show bots before countdown

            const textDisplay = document.getElementById('text-display');
            if (!textDisplay) return;

            // --- Countdown Logic ---
            textDisplay.innerHTML = '<div class="w-full text-center"><span class="text-6xl font-bold">3</span></div>';
            await sleep(1000);
            textDisplay.innerHTML = '<div class="w-full text-center"><span class="text-6xl font-bold">2</span></div>';
            await sleep(1000);
            textDisplay.innerHTML = '<div class="w-full text-center"><span class="text-6xl font-bold">1</span></div>';
            await sleep(1000);
            textDisplay.innerHTML = '<div class="w-full text-center"><span class="text-6xl font-bold text-green-400">GO!</span></div>';
            await sleep(500);

            // --- Start the actual race ---
            gameState.countdownActive = false;
            gameState.gameActive = true;
            gameState.text = texts[Math.floor(Math.random() * texts.length)];
            renderText();
            gameState.startTime = new Date();
            gameState.gameLoopInterval = setInterval(updateGame, 500);
            resetInactivityTimer();
        }
        
        function updateGame() {
            if (!gameState.startTime || !gameState.gameActive) return;

            // --- Update Player WPM and Accuracy ---
            const elapsedTimeInSeconds = (new Date() - gameState.startTime) / 1000;
            if (elapsedTimeInSeconds > 0) {
                const wordsTyped = gameState.currentIndex / 5;
                const wpm = Math.round((wordsTyped / elapsedTimeInSeconds) * 60);
                const wpmEl = document.getElementById('wpm');
                if (wpmEl) wpmEl.textContent = wpm || 0;
            }
            
            const totalAttempts = gameState.currentIndex + gameState.errors;
            const accuracy = totalAttempts > 0 ? Math.round((gameState.currentIndex / totalAttempts) * 100) : 100;
            const accuracyEl = document.getElementById('accuracy');
            if (accuracyEl) accuracyEl.textContent = `${accuracy}%`;

            // --- Update Bot Positions ---
            gameState.activeBots.forEach((bot, index) => {
                const botCarEl = document.getElementById(`bot-car-${index}`);
                if (botCarEl) {
                    // Simulate bot typing progress based on its stats and elapsed time
                    const botCharsPerSecond = (bot.wpm * 5) / 60;
                    const botTargetChars = Math.floor(botCharsPerSecond * elapsedTimeInSeconds * (bot.accuracy / 100));
                    const botProgress = (botTargetChars / gameState.text.length) * 90; // 90% is the finish line
                    botCarEl.style.left = `${Math.min(90, Math.max(1, botProgress))}%`;
                    bot.currentProgress = botTargetChars; // Store bot's progress
                }
            });
        }


        function initializeBotsForRace() {
            const botLanesContainer = document.getElementById('bot-lanes-container');
            if (!botLanesContainer) return;
            botLanesContainer.innerHTML = ''; // Clear previous bot lanes

            gameState.activeBots = [];
            let possibleBots = [...bots]; // Copy all bots

            // Determine if E-L-A-K bot should spawn (15% chance)
            const elakBotIndex = possibleBots.findIndex(bot => bot.name === 'E-L-A-K bot');
            if (elakBotIndex !== -1 && Math.random() < 0.15) { // 15% chance
                gameState.activeBots.push({ ...possibleBots[elakBotIndex], currentProgress: 0 });
                possibleBots.splice(elakBotIndex, 1); // Remove E-L-A-K from general pool
            } else {
                // If E-L-A-K doesn't spawn, add CORTEX instead
                const cortexBotIndex = possibleBots.findIndex(bot => bot.name === 'CORTEX');
                if (cortexBotIndex !== -1) {
                    gameState.activeBots.push({ ...possibleBots[cortexBotIndex], currentProgress: 0 });
                    possibleBots.splice(cortexBotIndex, 1); // Remove CORTEX from general pool
                }
            }

            // Select up to 2 more random bots (or fewer if E-L-A-K/CORTEX is present or not enough bots)
            while (gameState.activeBots.length < 3 && possibleBots.length > 0) {
                // Ensure we don't re-add a special bot if it was already considered
                const availableBots = possibleBots.filter(b => !b.special && b.name !== 'CORTEX' && b.name !== 'E-L-A-K bot');
                if (availableBots.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * availableBots.length);
                const chosenBot = availableBots[randomIndex];
                gameState.activeBots.push({ ...chosenBot, currentProgress: 0 });

                // Remove the chosen bot from the main `possibleBots` array to avoid re-selection
                const originalIndex = possibleBots.findIndex(b => b.name === chosenBot.name);
                if(originalIndex > -1) {
                    possibleBots.splice(originalIndex, 1);
                }
            }

            // Render bot cars and labels
            gameState.activeBots.forEach((bot, index) => {
                const botLaneDiv = document.createElement('div');
                botLaneDiv.className = 'lane';
                botLaneDiv.id = `bot-lane-${index}`;
                botLaneDiv.innerHTML = `
                    <span class="lane-label">${bot.name}</span>
                    <div id="bot-car-${index}" class="car absolute" style="left: 1%;">
                        ${carDesigns[bot.car].svg()}
                    </div>
                `;
                botLanesContainer.appendChild(botLaneDiv);
            });
        }

        function resetGame() {
            clearInterval(gameState.gameLoopInterval); // Clear the main game loop
            clearTimeout(inactivityTimer); // Clear inactivity timer on reset
            gameState = { text: '', currentIndex: 0, errors: 0, startTime: null, gameLoopInterval: null, gameActive: false, countdownActive: false, lastKeyPressTime: new Date(), nitroUsed: false, activeBots: [] };
            const gameView = document.getElementById('game-view');
            if (!gameView) return; // Null check
            
            const wpmEl = gameView.querySelector('#wpm');
            if (wpmEl) wpmEl.textContent = '--';
            const accuracyEl = gameView.querySelector('#accuracy');
            if (accuracyEl) accuracyEl.textContent = '--';
            
            const playerCar = document.getElementById('player-car');
            if (playerCar) {
                playerCar.style.left = '1%';
                playerCar.innerHTML = carDesigns[player.car || 'firestorm'].svg();
            }
            const textDisplayEl = gameView.querySelector('#text-display');
            if (textDisplayEl) textDisplayEl.innerHTML = "Click 'Race' to start!";

            const botLanesContainer = document.getElementById('bot-lanes-container');
            if (botLanesContainer) {
                botLanesContainer.innerHTML = ''; // Clear bot lanes
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (gameState.gameActive) {
                    endGame("inactivity"); // End game due to inactivity
                }
            }, 45000); // 45 seconds
        }

        function renderText() {
            const textDisplay = document.getElementById('text-display');
            if (!textDisplay) return; // Null check
            textDisplay.innerHTML = '';
            gameState.text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                span.classList.add('letter');
                if (index === 0) span.classList.add('current');
                textDisplay.appendChild(span);
            });
        }

        function handleTyping(e) {
            // Ensure the game is active and the results modal is hidden before processing key presses
            const resultsModal = document.getElementById('results-modal');
            if (!gameState.gameActive || (resultsModal && !resultsModal.classList.contains('hidden'))) return;

            // Handle Nitro Skip Word (Enter or Tab)
            if ((e.key === 'Enter' || e.key === 'Tab') && !gameState.nitroUsed) {
                e.preventDefault();
                gameState.nitroUsed = true;
                const letters = document.getElementById('text-display')?.querySelectorAll('.letter');
                if (!letters) return;

                const remainingText = gameState.text.substring(gameState.currentIndex);
                const nextSpaceIndex = remainingText.indexOf(' ');
                let charsToSkip;

                if (nextSpaceIndex !== -1) {
                    // Skips to the character after the next space, effectively skipping the whole word.
                    charsToSkip = nextSpaceIndex + 1;
                } else {
                    // If it's the last word, skip to the end of the text.
                    charsToSkip = remainingText.length;
                }

                if (charsToSkip > 0) {
                    for (let i = 0; i < charsToSkip; i++) {
                        if (gameState.currentIndex < gameState.text.length) {
                            letters[gameState.currentIndex].classList.remove('current', 'incorrect');
                            letters[gameState.currentIndex].classList.add('correct');
                            gameState.currentIndex++;
                        }
                    }
                }
                
                if (gameState.currentIndex >= gameState.text.length) {
                    endGame();
                    return;
                }
                
                if (letters[gameState.currentIndex]) {
                    letters[gameState.currentIndex].classList.add('current');
                }
                
                updateCarPosition();
                resetInactivityTimer();
                return;
            }

            // Only process single character keys for regular typing
            if (e.key.length !== 1) return;
            e.preventDefault();

            resetInactivityTimer();

            const expectedChar = gameState.text[gameState.currentIndex];
            const letters = document.getElementById('text-display')?.querySelectorAll('.letter');
            if (!letters || !letters[gameState.currentIndex]) return;
            const currentLetterEl = letters[gameState.currentIndex];

            if (e.key === expectedChar) {
                currentLetterEl.classList.remove('current', 'incorrect');
                currentLetterEl.classList.add('correct');
                gameState.currentIndex++;
                updateCarPosition();
                if (gameState.currentIndex === gameState.text.length) {
                    endGame();
                    return;
                }
                if (letters[gameState.currentIndex]) {
                    letters[gameState.currentIndex].classList.add('current');
                }
            } else {
                currentLetterEl.classList.add('incorrect');
                gameState.errors++;
            }
        }


        function updateCarPosition() {
            const pCar = document.getElementById('player-car');
            if (!pCar) return; // Null check
            const progress = (gameState.currentIndex / gameState.text.length) * 90;
            pCar.style.left = `${Math.max(1, progress)}%`;
        }

        // --- FIXED endGame function ---
        async function endGame(reason = "completed") {
            if (!gameState.gameActive) return;
            gameState.gameActive = false;
            clearInterval(gameState.gameLoopInterval);
            clearTimeout(inactivityTimer);

            // --- Calculations ---
            const elapsedTimeInSeconds = gameState.startTime ? (new Date() - gameState.startTime) / 1000 : 0;
            const finalWPM = elapsedTimeInSeconds > 0 ? Math.round(((gameState.currentIndex / 5) / elapsedTimeInSeconds) * 60) : 0;
            const totalAttempts = gameState.currentIndex + gameState.errors;
            const finalAccuracy = totalAttempts > 0 ? Math.round((gameState.currentIndex / totalAttempts) * 100) : 100;
            const incorrectCharactersTyped = gameState.errors;

            // --- Determine Rankings ---
            const participants = [{ name: player.username, progress: gameState.currentIndex, type: 'player' }];
            gameState.activeBots.forEach(bot => {
                participants.push({ name: bot.name, progress: bot.currentProgress || 0, type: 'bot', special: bot.special });
            });
            participants.sort((a, b) => b.progress - a.progress);
            const playerFinalIndex = participants.findIndex(p => p.type === 'player');
            
            // --- Determine Cash & Title ---
            let cashEarned = 0;
            let resultTitle = "Race Finished!";
            
            if (reason === "inactivity") {
                resultTitle = "Race Forfeited";
            } else {
                cashEarned = 100 + Math.round(finalWPM * (finalAccuracy / 100) * 2);

                const elakBot = participants.find(p => p.name === 'E-L-A-K bot' && p.special);
                if (elakBot && playerFinalIndex < participants.findIndex(p => p.name === 'E-L-A-K bot')) {
                    cashEarned += 1000000; 
                    setTimeout(() => showMessageBox("BONUS! You beat the E-L-A-K bot and earned $1,000,000!"), 500);
                }
                player.cash += cashEarned;
            }

            // --- Update Player Stats & Achievements ---
            if(!player.stats) player.stats = { totalRaces: 0, highestWpm: 0 };
            if (reason !== "inactivity") {
                player.stats.totalRaces = (player.stats.totalRaces || 0) + 1;
            }
            player.stats.highestWpm = Math.max(player.stats.highestWpm || 0, finalWPM);
            
            if(!player.achievements) player.achievements = [];
            if (!player.achievements.includes('first_race')) player.achievements.push('first_race');
            if (finalWPM >= 50 && !player.achievements.includes('wpm_50')) player.achievements.push('wpm_50');
            if (player.cash >= 1000 && !player.achievements.includes('cash_1000')) player.achievements.push('cash_1000');
            if (finalWPM >= 75 && !player.achievements.includes('wpm_75')) player.achievements.push('wpm_75');
            if (finalAccuracy >= 98 && !player.achievements.includes('accuracy_98')) player.achievements.push('accuracy_98');
            if (player.stats.totalRaces >= 10 && !player.achievements.includes('races_10')) player.achievements.push('races_10');
            if (player.stats.totalRaces >= 25 && !player.achievements.includes('races_25')) player.achievements.push('races_25');
            if (player.cash >= 5000 && !player.achievements.includes('cash_5000')) player.achievements.push('cash_5000');
            if (finalWPM >= 100 && !player.achievements.includes('wpm_100')) player.achievements.push('wpm_100');
            if (finalAccuracy === 100 && !player.achievements.includes('perfect_accuracy')) player.achievements.push('perfect_accuracy');
            if (player.stats.totalRaces >= 50 && !player.achievements.includes('races_50')) player.achievements.push('races_50');
            if (player.stats.totalRaces >= 100 && !player.achievements.includes('races_100')) player.achievements.push('races_100');
            if (player.cash >= 10000 && !player.achievements.includes('cash_10000')) player.achievements.push('cash_10000');
            if (finalWPM >= 120 && !player.achievements.includes('wpm_120')) player.achievements.push('wpm_120');
            if (player.stats.totalRaces >= 250 && !player.achievements.includes('races_250')) player.achievements.push('races_250');
            if (player.stats.totalRaces >= 500 && !player.achievements.includes('races_500')) player.achievements.push('races_500');
            if (player.cash >= 50000 && !player.achievements.includes('cash_50k')) player.achievements.push('cash_50k');
            if (player.cash >= 100000 && !player.achievements.includes('cash_100k')) player.achievements.push('cash_100k');
            if (player.cash >= 1000000 && !player.achievements.includes('cash_1m')) player.achievements.push('cash_1m');
            if (finalWPM >= 150 && !player.achievements.includes('wpm_150')) player.achievements.push('wpm_150');
            if (finalWPM >= 200 && !player.achievements.includes('wpm_200')) player.achievements.push('wpm_200');
            if (player.owned_cars.length >= 50 && !player.achievements.includes('car_collector_50')) player.achievements.push('car_collector_50');
            if (player.owned_cars.length >= 100 && !player.achievements.includes('car_collector_100')) player.achievements.push('car_collector_100');
            const allAchievementKeys = Object.keys(achievements);
            const unlockedAllAchievements = allAchievementKeys.every(achKey => player.achievements.includes(achKey));
            if (unlockedAllAchievements && !player.achievements.includes('all_achievements')) player.achievements.push('all_achievements');
            const allCarKeys = Object.keys(carDesigns).filter(key => !carDesigns[key].adminOnly && !key.startsWith('bot_'));
            const ownedAllCars = allCarKeys.every(carKey => player.owned_cars.includes(carKey));
            if (ownedAllCars && !player.achievements.includes('all_cars')) player.achievements.push('all_cars');
            
            // --- Update Database & UI ---
            await updatePlayerOnDb();
            document.getElementById('player-cash').textContent = `$${player.cash}`;
            document.getElementById('player-races').textContent = `Races: ${player.stats.totalRaces}`;

            // --- Show and Populate Results Modal ---
            const resultsModal = document.getElementById('results-modal');
            if (resultsModal) {
                document.getElementById('results-title').textContent = resultTitle;
                document.getElementById('final-wpm').textContent = finalWPM;
                document.getElementById('final-accuracy').textContent = `${finalAccuracy}%`;
                document.getElementById('final-cash').textContent = `$${cashEarned}`;
                document.getElementById('final-incorrect-chars').textContent = incorrectCharactersTyped;
                document.getElementById('final-time-taken').textContent = `${elapsedTimeInSeconds.toFixed(1)}s`;
                document.getElementById('race-rankings').innerHTML = participants.map((p, i) => `<li>${i + 1}. ${p.name}</li>`).join('');
                
                resultsModal.classList.remove('hidden');
            }

            await updateShop();
            await updateAchievements();
        }

    </script>
</body>
</html>